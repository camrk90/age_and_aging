ggplot(aes(x = percent, y=anno_class, fill = factor({{x}}))) +
geom_bar(stat="identity", width = 0.7, colour="black") +
theme_classic(base_size=32) +
#geom_vline(xintercept = (1-d2$perc[col1 == "Age-Hypermethylated"])*100, linetype = 'dashed') +
#geom_vline(xintercept = d2$perc[col1 == "Age-Hypomethylated"]*100, linetype = 'dashed') +
#theme(legend.position = "none") +
#scale_fill_manual(values = c(c1, c2, c3)) +
ylab("Annotation") +
xlab("Percentage")
}
df<- generate_proportion(pqlseq_anno, direction)
#Plot annotation proportions----------------------------------------------------
generate_proportion<- function(df, x){
d1<- df %>%
distinct(unique_cpg, .keep_all = T) %>%
group_by(anno_class, {{x}}) %>%
summarise(count = n()) %>%
mutate(perc = count/sum(count))
print(d1)
d2<- df %>%
distinct(unique_cpg, .keep_all = T) %>%
group_by({{x}}) %>%
summarise(count = n()) %>%
mutate(perc = count/sum(count))
d2$anno_class<- "All"
d3<- rbind(d1, d2)
annos2<- unique(d3$anno_class)
d3$anno_class<- factor(d3$anno_class, levels = annos2)
col1 <- eval(substitute(x), d2)
d3$percent<- d3$perc*100
d3 %>%
ggplot(aes(x = percent, y=anno_class, fill = factor({{x}}))) +
geom_bar(stat="identity", width = 0.7, colour="black") +
theme_classic(base_size=32) +
#geom_vline(xintercept = (1-d2$perc[col1 == "Age-Hypermethylated"])*100, linetype = 'dashed') +
#geom_vline(xintercept = d2$perc[col1 == "Age-Hypomethylated"]*100, linetype = 'dashed') +
#theme(legend.position = "none") +
#scale_fill_manual(values = c(c1, c2, c3)) +
ylab("Annotation") +
xlab("Percentage")
}
generate_proportion(pqlseq_anno, direction)
View(test)
library(tidyverse)
library(ggplot2)
library(ggcorrplot)
library(ggvenn)
library(variancePartition)
library(lme4)
load("/scratch/ckelsey4/Cayo_meth/cross_within_compare.RData")
#Eq. 3
age_eq3_files<- 'wb_pqlseq2_eq3'
age_eq3_pqlseq<- import_pqlseq(age_eq3_files, y = 4)
#Import longitudinal pqlseq files
setwd('/scratch/ckelsey4/Cayo_meth/glmer_model_compare')
#Eq. 3
age_eq3_files<- 'wb_pqlseq2_eq3'
age_eq3_pqlseq<- import_pqlseq(age_eq3_files, y = 4)
age_eq3<- age_eq3_pqlseq %>%
select(c(outcome, beta, fdr))
colnames(age_eq3)<- c("outcome", "eq3_beta", "eq3_fdr")
age_w<- age_w_pqlseq  %>%
select(c(outcome, beta, fdr))
age_w<- age_w[age_w$outcome %in% age_eq3$outcome,]
age_w<- age_w_pqlseq  %>%
select(c(outcome, beta, fdr))
#Chronological Age
chron_age_files<- 'wb_pqlseq2_agechron'
chron_age_pqlseq<- import_pqlseq(chron_age_files, y = 4)
#Age Within
age_w_files<- 'wb_pqlseq2_within_age'
age_w_pqlseq<- import_pqlseq(age_w_files, y = 5)
#Mean Age
age_m_files<- 'wb_pqlseq2_mean_age'
age_m_pqlseq<- import_pqlseq(age_m_files, y = 5)
age_w<- age_w_pqlseq  %>%
select(c(outcome, beta, fdr))
colnames(age_w)<- c("outcome", "age_w_beta", "age_w_fdr")
age_w<- age_w[age_w$outcome %in% age_eq3$outcome,]
View(age_eq3)
#Eq2 vs Eq3--------------
age_eq3<- age_eq3_pqlseq %>%
select(c(outcome, beta, fdr)) %>%
mutate(eq = "eq3")
age_w<- age_w_pqlseq  %>%
select(c(outcome, beta, fdr)) %>%
mutate(eq = "eq2")
age_w<- age_w[age_w$outcome %in% age_eq3$outcome,]
age_compare<- rbind(age_w, age_eq3)
View(age_compare)
age_compare %>%
ggplot(aes(beta, fill = eq)) +
geom_histogram(alpha=0.5)
age_compare %>%
ggplot(aes(beta, fill = eq)) +
geom_histogram(alpha=0.5, position = position_dodge())
age_compare %>%
ggplot(aes(beta, fill = eq)) +
geom_density(alpha=0.5, position = position_dodge())
age_compare %>%
filter(fdr < 0.05) %>%
ggplot(aes(beta, fill = eq)) +
geom_density(alpha=0.5, position = position_dodge())
age_compare %>%
filter(fdr < 0.05) %>%
ggplot(aes(beta, fill = eq)) +
geom_density(alpha=0.5, position = position_dodge()) +
theme_classic(base_size=24)
library(tidyverse)
library(ggplot2)
library(ggcorrplot)
library(ggvenn)
library(variancePartition)
library(lme4)
load("/scratch/ckelsey4/Cayo_meth/cross_within_compare.RData")
######################################
###       Descriptive Stats        ###
######################################
#Cross-age age distribution
blood_metadata %>%
ggplot(aes(age_at_sampling, fill=individual_sex)) +
geom_histogram(position = "dodge", colour = "black") +
scale_x_continuous(breaks = seq(0, 30, by=5)) +
scale_fill_manual(values = c("steelblue1", "steelblue4"), name = "Sex") +
theme_classic(base_size=24) +
ylab("Count") +
xlab("Age")
#Longitudinal data distribution
long_data %>%
ggplot(aes(age_at_sampling, fill=individual_sex)) +
geom_histogram(position = "dodge", colour = "black") +
scale_x_continuous(breaks = seq(0, 30, by=5)) +
scale_fill_manual(values = c("purple", "purple4"), name = "Sex") +
theme_classic(base_size=24) +
ylab("Count") +
xlab("Age")
long_data %>%
ggplot(aes(mean.age, fill=individual_sex)) +
geom_histogram(position = "dodge", colour = "black") +
scale_x_continuous(breaks = seq(0, 30, by=5)) +
scale_fill_manual(values = c("purple", "purple4"), name = "Sex") +
theme_classic(base_size=24) +
ylab("Count") +
xlab("Age")
long_data %>%
ggplot(aes(mean.age, fill=individual_sex)) +
geom_histogram(position = "dodge", colour = "black") +
scale_x_continuous(breaks = seq(0, 30, by=5)) +
scale_fill_manual(values = c("purple", "purple4"), name = "Sex") +
theme_classic(base_size=24) +
ylab("Count") +
xlab("Mean Age")
ggsave("/home/ckelsey4/Cayo_meth/age_aging/cross_age.svg", plot = last_plot(),
width = 89, height = 89, units = "mm")
blood_metadata %>%
ggplot(aes(age_at_sampling, fill=individual_sex)) +
geom_histogram(position = "dodge", colour = "black") +
scale_x_continuous(breaks = seq(0, 30, by=5)) +
scale_fill_manual(values = c("steelblue1", "steelblue4"), name = "Sex") +
theme_classic(base_size=24) +
ylab("Count") +
xlab("Age")
ggsave("/home/ckelsey4/Cayo_meth/age_aging/cross_age.svg", plot = last_plot(),
width = 89, height = 89, units = "mm")
######################################
###       Descriptive Stats        ###
######################################
#Cross-age age distribution
blood_metadata %>%
ggplot(aes(age_at_sampling, fill=individual_sex)) +
geom_histogram(position = "dodge", colour = "black") +
scale_x_continuous(breaks = seq(0, 30, by=5)) +
scale_fill_manual(values = c("steelblue1", "steelblue4"), name = "Sex") +
theme_classic(base_size=24) +
ylab("Count") +
xlab("Age")
ggsave("/home/ckelsey4/Cayo_meth/age_aging/cross_age.svg", plot = last_plot(),
width = 89, height = 150, units = "mm")
ggsave("/home/ckelsey4/Cayo_meth/age_aging/cross_age.svg", plot = last_plot())
######################################
###       Descriptive Stats        ###
######################################
#Cross-age age distribution
blood_metadata %>%
ggplot(aes(age_at_sampling, fill=individual_sex)) +
geom_histogram(position = "dodge", colour = "black") +
scale_x_continuous(breaks = seq(0, 30, by=5)) +
scale_fill_manual(values = c("steelblue1", "steelblue4"), name = "Sex") +
theme_classic(base_size=12) +
ylab("Count") +
xlab("Age")
ggsave("/home/ckelsey4/Cayo_meth/age_aging/cross_age.svg", plot = last_plot())
######################################
###       Descriptive Stats        ###
######################################
#Cross-age age distribution
blood_metadata %>%
ggplot(aes(age_at_sampling, fill=individual_sex)) +
geom_histogram(position = "dodge", colour = "black") +
scale_x_continuous(breaks = seq(0, 30, by=5)) +
scale_fill_manual(values = c("steelblue1", "steelblue4"), name = "Sex") +
theme_classic(base_size=12) +
scale_y_continuous(breaks = seq(0, 30, 5)) +
ylab("Count") +
xlab("Age")
######################################
###       Descriptive Stats        ###
######################################
#Cross-age age distribution
blood_metadata %>%
ggplot(aes(age_at_sampling, fill=individual_sex)) +
geom_histogram(position = "dodge", colour = "black") +
scale_x_continuous(breaks = seq(0, 30, by=5)) +
scale_fill_manual(values = c("steelblue1", "steelblue4"), name = "Sex") +
theme_classic(base_size=12) +
scale_y_continuous(breaks = seq(0, 30, 5)) +
ylim(0, 30) +
ylab("Count") +
xlab("Age")
######################################
###       Descriptive Stats        ###
######################################
#Cross-age age distribution
blood_metadata %>%
ggplot(aes(age_at_sampling, fill=individual_sex)) +
geom_histogram(position = "dodge", colour = "black") +
scale_x_continuous(breaks = seq(0, 30, by=5)) +
scale_fill_manual(values = c("steelblue1", "steelblue4"), name = "Sex") +
theme_classic(base_size=12) +
scale_y_continuous(breaks = seq(0, 30, 5)) +
ylab("Count") +
xlab("Age")
######################################
###       Descriptive Stats        ###
######################################
#Cross-age age distribution
blood_metadata %>%
ggplot(aes(age_at_sampling, fill=individual_sex)) +
geom_histogram(position = "dodge", colour = "black") +
scale_x_continuous(breaks = seq(0, 30, by=5)) +
scale_fill_manual(values = c("steelblue1", "steelblue4"), name = "Sex") +
theme_classic(base_size=12) +
scale_y_continuous(breaks = seq(0, 30, 5)) +
coord_cartesian(ylim = (0, 30)) +
######################################
###       Descriptive Stats        ###
######################################
#Cross-age age distribution
blood_metadata %>%
ggplot(aes(age_at_sampling, fill=individual_sex)) +
geom_histogram(position = "dodge", colour = "black") +
scale_x_continuous(breaks = seq(0, 30, by=5)) +
scale_fill_manual(values = c("steelblue1", "steelblue4"), name = "Sex") +
theme_classic(base_size=12) +
scale_y_continuous(breaks = seq(0, 30, 5)) +
coord_cartesian(ylim = c(0, 30)) +
ylab("Count") +
xlab("Age")
#Longitudinal data distribution
long_data %>%
ggplot(aes(age_at_sampling, fill=individual_sex)) +
geom_histogram(position = "dodge", colour = "black") +
scale_x_continuous(breaks = seq(0, 30, by=5)) +
scale_y_continuous(breaks = seq(0, 30, 5)) +
coord_cartesian(ylim = c(0, 30)) +
scale_fill_manual(values = c("purple", "purple4"), name = "Sex") +
theme_classic(base_size=24) +
ylab("Count") +
xlab("Age")
#Longitudinal data distribution
long_data %>%
ggplot(aes(age_at_sampling, fill=individual_sex)) +
geom_histogram(position = "dodge", colour = "black") +
scale_x_continuous(breaks = seq(0, 30, by=5)) +
#scale_y_continuous(breaks = seq(0, 30, 5)) +
#coord_cartesian(ylim = c(0, 30)) +
scale_fill_manual(values = c("purple", "purple4"), name = "Sex") +
theme_classic(base_size=24) +
ylab("Count") +
xlab("Age")
#Longitudinal data distribution
long_data %>%
ggplot(aes(age_at_sampling, fill=individual_sex)) +
geom_histogram(position = "dodge", colour = "black") +
scale_x_continuous(breaks = seq(0, 30, by=5)) +
#scale_y_continuous(breaks = seq(0, 30, 5)) +
coord_cartesian(ylim = c(0, 30)) +
scale_fill_manual(values = c("purple", "purple4"), name = "Sex") +
theme_classic(base_size=24) +
ylab("Count") +
xlab("Age")
#Longitudinal data distribution
long_data %>%
ggplot(aes(age_at_sampling, fill=individual_sex)) +
geom_histogram(position = "dodge", colour = "black") +
scale_x_continuous(breaks = seq(0, 30, by=5)) +
scale_y_continuous(breaks = seq(0, 30, 5)) +
#coord_cartesian(ylim = c(0, 30)) +
scale_fill_manual(values = c("purple", "purple4"), name = "Sex") +
theme_classic(base_size=24) +
ylab("Count") +
xlab("Age")
#Longitudinal data distribution
long_data %>%
ggplot(aes(age_at_sampling, fill=individual_sex)) +
geom_histogram(position = "dodge", colour = "black") +
scale_x_continuous(breaks = seq(0, 20, by=5)) +
scale_y_continuous(breaks = seq(0, 20, 5)) +
#coord_cartesian(ylim = c(0, 30)) +
scale_fill_manual(values = c("purple", "purple4"), name = "Sex") +
theme_classic(base_size=24) +
ylab("Count") +
xlab("Age")
#Longitudinal data distribution
long_data %>%
ggplot(aes(age_at_sampling, fill=individual_sex)) +
geom_histogram(position = "dodge", colour = "black") +
scale_x_continuous(breaks = seq(0, 30, by=5)) +
scale_y_continuous(breaks = seq(0, 20, 5)) +
coord_cartesian(ylim = c(0, 20)) +
scale_fill_manual(values = c("purple", "purple4"), name = "Sex") +
theme_classic(base_size=24) +
ylab("Count") +
xlab("Age")
long_data %>%
ggplot(aes(mean.age, fill=individual_sex)) +
geom_histogram(position = "dodge", colour = "black") +
scale_x_continuous(breaks = seq(0, 30, by=5)) +
scale_y_continuous(breaks = seq(0, 30, 5)) +
coord_cartesian(ylim = c(0, 30)) +
scale_fill_manual(values = c("purple", "purple4"), name = "Sex") +
theme_classic(base_size=24) +
ylab("Count") +
xlab("Mean Age")
library(tidyverse)
ela_meta<- readRDS("/scratch/rpeter39/Cayo_pbmc/Cayo_PBMC_longLPS_metadata_wELA_18Jul25.rds")
ela_meta<- ela_meta %>%
filter(Stimulation == "H2O") %>%
select(c(animal_ID, sex, trapped_age, trapping_ID, Sample_ID, Seq_batch))
rna_meta<- readRDS("/home/ckelsey4/data/metadata_Ashlee.rds")
rna_meta<- rna_meta %>%
mutate(lid = rownames(rna_meta),
lid_pid = paste(lid, pid, sep = "_")) %>%
relocate(lid, .before = age) %>%
relocate(pid, .after = lid) %>%
relocate(lid_pid, .after = pid)
rna_meta<- rna_meta %>%
relocate(cayoid, .before = lid) %>%
rename(monkey_id = cayoid)
control_rna<- rna_meta %>%
select(-pid_stimulation) %>%
filter(stimulation == "cont")
control_rna<- control_rna %>%
group_by(monkey_id) %>%
mutate(n = n()) %>%
ungroup()
control_rna<- control_rna %>%
select(c(monkey_id, sex, age, trapid, rid, batch))
colnames(control_rna)<- colnames(ela_meta)
View(control_rna)
View(ela_meta)
control_rna$sex<- toupper(control_rna$sex)
View(rna_meta)
rna_meta %>% filter(monkey_id == '52Z')
rna_counts<- readRDS("/home/ckelsey4/data/counts_Ashlee.rds")
View(rna_counts)
compare<- full_join(control_rna, ela_meta, by = trapping_ID)
compare<- full_join(control_rna, ela_meta, by = trapping_ID)
compare<- full_join(control_rna, ela_meta)
View(compare)
compare2<- compare %>% group_by(animal_ID) %>% distinct(animal_ID, .keep_all = T)
View(compare2)
compare2<- mutate(n = n())
compare2<- group_by(animal_ID) %>% mutate(n = n()) filter(n > 1)
compare2<- compare2 %>% group_by(animal_ID) %>% mutate(n = n()) filter(n > 1)
compare2<- compare2 %>% group_by(animal_ID) %>% mutate(n = n()) %>% filter(n > 1)
rm(compare2)
ela_meta<- readRDS("/scratch/rpeter39/Cayo_pbmc/Cayo_PBMC_longLPS_metadata_wELA_18Jul25.rds")
View(ela_meta)
ela_meta<- ela_meta %>%
filter(Stimulation == "H2O") %>%
select(c(animal_ID, sex, trapped_age, trapping_ID, Sample_ID, Seq_batch))
View(rna_meta)
ela_meta %>% filter(trapped_ID == "T20120")
ela_meta %>% filter(trapping_ID == "T20120")
ela_meta %>% filter(animal_ID == "51Z")
ela_meta<- readRDS("/home/ckelsey4/Cayo_meth/rna_seq/Cayo_PBMC_longLPS_metadata_wELA_18Jul25.rds")
View(ela_meta)
ela_meta<- ela_meta %>%
filter(Stimulation == "H2O") %>%
select(c(animal_ID, sex, trapped_age, trapping_ID, Sample_ID, Seq_batch))
library(tidyverse)
ela_meta<- ela_meta %>%
filter(Stimulation == "H2O") %>%
select(c(animal_ID, sex, trapped_age, trapping_ID, Sample_ID, Seq_batch))
ela_meta$trapped_age<- round(ela_meta$trapped_age, 0)
ela_meta<- ela_meta %>%
group_by(animal_ID) %>%
mutate(min_age = min(trapped_age))
ela_meta$trapped_age<- round(ela_meta$trapped_age, 0)
ela_meta %>%
ggplot(aes(x=trapped_age, y=reorder(animal_ID, min_age), colour=sex)) +
geom_path(linewidth = 1.2, alpha = 0.8) +
geom_point(colour="black") +
scale_x_continuous(breaks = seq(0, 30, by=5)) +
#scale_colour_manual(values = c("purple", "purple4"), name = "Sex") +
ylab("Individual") +
xlab("Age") +
theme_classic(base_size = 24) +
theme(axis.text.y=element_blank(),
axis.ticks.y=element_blank())
rna_counts<- readRDS("/home/ckelsey4/Cayo_meth/rna_seq/Cayo_PBMC_longLPS_counts_18Jul25.rds")
View(rna_counts)
View(ela_meta)
meta2<- readRDS("/home/ckelsey4/data/metadata_Ashlee.rds")
View(meta2)
meta2<- meta2[meta2$cayoid %in% ela_meta$animal_ID,]
View(meta2)
meta2<- readRDS("/home/ckelsey4/data/metadata_Ashlee.rds")
meta3<- meta2[ela_meta$animal_ID %in% meta2$cayoid,]
View(meta3)
View(meta2)
meta2<- readRDS("/home/ckelsey4/data/metadata_Ashlee.rds")
View(ela_meta)
meta3<- meta2[ela_meta$animal_ID %in% meta2$cayoid,]
rm(meta3)
meta3<- ela_meta[ela_meta$animal_ID %in% meta2$cayoid,]
View(meta3)
rna_meta<- readRDS("/home/ckelsey4/Cayo_meth/rna_seq/Cayo_PBMC_longLPS_metadata_wELA_18Jul25.rds")
View(rna_meta)
meta3<- rna_meta[rna_meta$Trap_Year < 2022]
meta3<- rna_meta[rna_meta$Trap_Year < 2022,]
View(meta3)
View(meta3)
rm(meta2);rm(meta3);rm(ela_meta)
rm(meta2);rm(meta3);rm(ela_meta)
View(rna_counts)
View(rna_meta)
rna_meta<- rna_meta %>%
filter(Stimulation == "H2O") %>%
select(c(animal_ID, sex, trapped_age, trapping_ID, Sample_ID, Seq_batch))
rna_counts<- rna_counts[colnames(rna_counts) %in% rna_meta$Sample_ID,]
rna_rids<- colnames(rna_counts)
rna_rids<- rna_rids[rna_rids %in% rna_meta$Sample_ID]
rna_counts<- rna_counts[, colnames(rna_counts) %in% rna_meta$Sample_ID]
rm(rna_rids)
View(rna_counts)
rna_meta<- rna_meta %>%
group_by(animal_ID) %>%
mutate(mean_age = mean(trapped_age)) %>%
mutate(within_age = trapped_age - mean_age)
rna_meta<- rna_meta %>%
group_by(animal_ID) %>%
mutate(mean_age = mean(trapped_age)) %>%
mutate(within_age = trapped_age - mean_age) %>%
arrange(animal_ID, trapped_age)
rna_meta$Seq_batch<- grepl("batch", rna_meta$Seq_batch, "")
rna_meta<- readRDS("/home/ckelsey4/Cayo_meth/rna_seq/Cayo_PBMC_longLPS_metadata_wELA_18Jul25.rds")
rna_meta<- rna_meta %>%
filter(Stimulation == "H2O") %>%
select(c(animal_ID, sex, trapped_age, trapping_ID, Sample_ID, Seq_batch))
rna_meta<- rna_meta %>%
group_by(animal_ID) %>%
mutate(mean_age = mean(trapped_age)) %>%
mutate(within_age = trapped_age - mean_age) %>%
arrange(animal_ID, trapped_age)
rna_meta$Seq_batch<- gsub("batch", "", rna_meta$Seq_batch)
rna_meta$Seq_batch<- factor(rna_meta$Seq_batch, levels = c("1", "2", "3"))
rna_meta$Seq_batch
library(tidyverse)
rna_meta<- readRDS("/home/ckelsey4/Cayo_meth/rna_seq/Cayo_PBMC_longLPS_metadata_wELA_18Jul25.rds")
rna_counts<- readRDS("/home/ckelsey4/Cayo_meth/rna_seq/Cayo_PBMC_longLPS_counts_18Jul25.rds")
#Subset to control and truncate df to relevant variables
rna_meta<- rna_meta %>%
filter(Stimulation == "H2O") %>%
select(c(animal_ID, sex, trapped_age, trapping_ID, Sample_ID, Seq_batch))
#Generate within and between age
rna_meta<- rna_meta %>%
group_by(animal_ID) %>%
mutate(mean_age = mean(trapped_age)) %>%
mutate(within_age = trapped_age - mean_age) %>%
arrange(animal_ID, trapped_age)
#Make batch factor
rna_meta$Seq_batch<- gsub("batch", "", rna_meta$Seq_batch)
rna_meta$Seq_batch<- factor(rna_meta$Seq_batch, levels = c("1", "2", "3"))
#Subset counts to RIDs in metadata
rna_counts<- rna_counts[, colnames(rna_counts) %in% rna_meta$Sample_ID]
View(rna_counts)
library(PQLseq2)
View(rna_counts)
View(rna_meta)
unique(rna_meta$Seq_batch)
install.packages('EMMREML')
library(EMMREML)
#Run PQLseq for within_age-------------------------------------------------------------
#Generate model matrix
predictor_matrix<- model.matrix(~ within_age + mean_age + sex + Seq_batch, data = rna_meta)
View(predictor_matrix)
rna_meta$y<- 1
re_eq = "y ~ within_age + mean_age + sex + Seq_batch + (1 + within_age|id)"
re_mat <- lFormula(eval(re_eq), rna_meta)
library(lme4)
re_mat <- lFormula(eval(re_eq), rna_meta)
re_eq = "y ~ within_age + mean_age + sex + Seq_batch + (1 + within_age|animal_ID)"
re_mat <- lFormula(eval(re_eq), rna_meta)
re_matZ <- t(as.matrix(foo$reTrms$Zt))
re_matZ <- t(as.matrix(re_mat$reTrms$Zt))
View(re_matZ)
dim(re_matZ)
length(unique(rna_me)
length(unique(rna_meta$animal_ID)
length(unique(rna_meta$animal_ID))
